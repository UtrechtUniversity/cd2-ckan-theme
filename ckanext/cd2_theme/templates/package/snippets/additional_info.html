

<script>
  document.addEventListener("DOMContentLoaded", function (event) {

    // hide empty repeating fields
    const repeatingElements = document.querySelectorAll('.repeating-element');
    repeatingElements.forEach(element => {
      if (!element.innerHTML.trim()) {
        element.parentElement.style.display = 'none';
      }
    });
  });
  

  {% if pkg_dict.type == 'measure' and pkg_dict.dc_common_id is defined %}
    // query api to find similar datasets based on CD2_ID
      url = "/api/3/action/package_search?fq=dc_common_id:{{pkg_dict.dc_common_id}}"
      fetch(url)
        .then(res => res.json())
        .then(data => {
          let divContent = '';
          const currentItem = '{{ pkg_dict.name }}';
          const div = document.getElementById('similar-datasets');
          if (data.result.results.length <= 1) { return; }
          for (item of data.result.results) {
            try {
              if (item.name == currentItem) { continue; } 
              console.log(item)
              let cohorts_passed = []; 
              let wave_count = 0;
              console.log(item.wave)
              console.log("length: " + item.wave.length)
              for (wave_item of item.wave) {
                if (!cohorts_passed.includes(wave_item.wave_cohort)) {
                  if (cohorts_passed.length > 0) {
                    divContent += `</div></a> `
                  }
                  if (item.dc_measure_name) {
                    display_name = item.dc_measure_name;
                  } else {
                    display_name = item.title;
                  }
                  divContent += `<a href="/dataset/`+item.name+`"><div style="font-size:10pt" class="cohort-spanner nofunc" onmouseenter="tooltipAddElement(this,'` + display_name.replace("'","\'") + `',30,'info-circle')" onmouseleave="tooltipRemoveElement(this)">`+wave_item.wave_cohort
                  cohorts_passed.push(wave_item.wave_cohort);
                }
                divContent += ` <span class="label">` + wave_item.wave_title + `</span>`
                wave_count ++;
                if (wave_count == item.wave.length) {
                  divContent += `</div></a> `
                }
              }
            
            } catch (error) {
              console.error('An error occurred while iterating through the results:', error);
              return;
            }
          }
          div.innerHTML += divContent + `<div style="margin:10px 5px"><strong><a href="/dataset/?dataset_type=dataset&amp;q=dc_common_id:%22{{pkg_dict.dc_common_id}}%22">View all</a></strong></div>`
          $('.similar-datasets').fadeTo(1, 1);
        });
    {% endif %}

    // query api to find data access information from study info
    url = "/api/3/action/package_show?id={{pkg_dict.organization.name}}"
    fetch(url)
    .then(res => res.json())
    .then(data => {
      const divInfo = document.getElementById('data-access-info');
      const divHref = document.getElementById('data-access-href');
      if (data.result.cohort_study_data_access){
        divInfo.innerHTML = data.result.cohort_study_data_access[0].cohort_study_data_access_description;
        divHref.innerHTML = `<a href="` + data.result.cohort_study_data_access[0].cohort_study_data_access_URL + `" target="blank"><span class="tabspan fa fa-external-link"></span> ` + data.result.cohort_study_data_access[0].cohort_study_data_access_URL + `</a>`;
        $('.data-access').fadeTo(1, 1);
      }
    });
</script>


{% if pkg_dict.dc_additional_info %} 
<p><span class="fa fa-info-circle"></span> {{pkg_dict.dc_additional_info}}
</p>
{% endif %}

<section class="additional-info">
  <table class="table table-striped table-condensed dropshadow">
   
    {% if pkg_dict.type == 'study' %}
    <tr>
    <th style="width: 20%" scope="row" class="dataset-label">Alternative title</th>
    <td class="dataset-details">
      <ul class="dataset-resources list-unstyled">
       {{ pkg_dict.cohort_study_alternate_title | replace('{','') | replace('}','') | replace('"','') | replace(',',', ') }}
      </ul>
    </td>
    </tr>


    {% elif pkg_dict.type == 'measure' %}
    <tr>
      <th style="width: 20%" scope="row" class="dataset-label">Labels</th>
      <td class="dataset-details">
      <ul class="dataset-resources list-unstyled">
      {% set labels = pkg_dict.dc_labels %}
      {% for label in labels  %}
        {% if label.length != 0 %}
        {% set labelname = label["dc_label"] %}
        <li>
          <a href="{% url_for 'dataset.search', dc_label=labelname %}" class="label label-info">{{label["dc_label"]}}</a>
        </li>
        {% endif %}
      {% endfor %}
      </ul>
      </td>
    </tr>

    <tr>
      <th scope="row" class="dataset-label">Constructs</th>
      <td class="dataset-details">
      <ul class="dataset-resources list-unstyled">
      {% set constructs = pkg_dict.dc_constructs %}
      {% for construct in constructs  %}
      {% if construct.length != 0 %}
      {% set constructname = construct["dc_construct"] %}
        <li>
          <a href="{% url_for 'dataset.search', dc_construct=constructname %}" class="label label-info info-hover" onmouseenter="tooltipAddElement(this,constructLegend('{{ construct["dc_construct"] }}'),40,'info-circle')" onmouseleave="tooltipRemoveElement(this)">{{construct["dc_construct"]}}</a>
          </li>
        {% endif %}
      {% endfor %}
    </ul>
    </td>
    </tr>
    <tr>
      <th scope="row" class="dataset-label">Available measurements</th>
      <td class="dataset-details">
      <div class="dataset-resources list-unstyled">

      {% set waves = pkg_dict.wave %}
      {% set waves_passed = [] %}
      {% for wave in waves %}
              {% if wave.wave_cohort %}
              {% if wave.wave_cohort not in waves_passed %}
                {% do waves_passed.append(wave.wave_cohort) %}
                {% if waves_passed|length > 1 %}
                  </div>
                {% endif %}
                {% set splitname = wave.wave_cohort.split(':') %}
                <div class="cohort-spanner parent-spanner"><a href="/cohort/{{ wave.wave_cohort_ckan_id }}"><li class="label label-cohort">{{ splitname[1] }} <span class="fa fa-level-down"></span></li></a><br />
              {% endif %}
              {% set waveDescription = wave.wave_description | replace("'","\&apos;") | replace('\n', '') %}
              {% set waveSubjectCode = wave.wave_subject_codes | replace("[","") | replace("]","") | replace("'","") %}
              <span class="cohort-spanner wave-spanner"><li onmouseenter="tooltipAddElement(this,'{{ waveDescription }}',40,'info-circle')" onmouseleave="tooltipRemoveElement(this)"><a href="/wave/{{ wave.wave_ckan_id }}" class="label label-info">{{wave.wave_title}}</a></li> 
              {% if ',' in waveSubjectCode %}
                {% set waveSubjectCodes = waveSubjectCode.split(',') %}
                {% for waveCode in waveSubjectCodes %}
                  <span class="label info-hover" onmouseenter="tooltipAddElement(this,createLegendString('{{ waveCode|trim }}'),40,'user-o')" onmouseleave="tooltipRemoveElement(this)">{{ waveCode|trim }}</span>
                {% endfor %}
              {% else %}
                <span class="label info-hover" onmouseenter="tooltipAddElement(this,createLegendString('{{ waveSubjectCode|trim }}'),40,'user-o')" onmouseleave="tooltipRemoveElement(this)">{{ waveSubjectCode }}</span>
              {% endif %}
              <hr style="border:0.5px solid">
              <span class="label" style="background-color:#aaa">
                {% if wave.wave_universe.find("-") == -1 %}
                  {% set value = wave.wave_universe|int %}
                  {% if value >= 48 %}
                    {{ value/12|round }} years
                  {% else %}
                    {{ value }} months
                  {% endif %}
                {% else %}
                  {% set parts = wave.wave_universe.split("-") %}
                  {% set start = parts[0]|int %}
                  {% set end = parts[1]|int %}
                  {% if start >= 48 %}
                    {{ (start/12)|round(1) }} -
                  {% else %}
                    {{ start }} months -
                  {% endif %}
                  {% if end >= 48 %}
                    {{ (end/12)|round(1) }} years
                  {% else %}
                    {{ end }} months
                  {% endif %}
                {% endif %}
              </span>&nbsp;
              {% if wave.wave_start_date_collection %}
              <span class="label" style="background-color:#aaa">
                From {{wave.wave_start_date_collection}} 
                {% if wave.wave_end_date_collection %} 
                to {{wave.wave_end_date_collection}} 
                {% else %}
                (ongoing)
                {% endif %}
              </span>
              {% endif %}
              </span><br />
              {% endif %}
      {% endfor %}
      </ul>
      </td>
    </tr>



    <tr>
      <th scope="row" class="dataset-label">Mode of collection</th>
      <td class="dataset-details">
      <span class="label info-hover" style="line-height:2" onmouseenter="tooltipAddElement(this,constructLegend('{{ pkg_dict.dc_mode_of_collection }}'),40,'info-circle')" onmouseleave="tooltipRemoveElement(this)">{{ pkg_dict.dc_mode_of_collection }}</span>
      {% if pkg_dict.dc_mode_of_collection_sub %}
      &nbsp;<i class="fa fa-chevron-right" aria-hidden="true" style="color:#777"></i>&nbsp;<span class="label info-hover" style="line-height:2" onmouseenter="tooltipAddElement(this,constructLegend('{{ pkg_dict.dc_mode_of_collection_sub }}'),40,'info-circle')" onmouseleave="tooltipRemoveElement(this)">{{ pkg_dict.dc_mode_of_collection_sub }}</span>
      {% endif %}
      </td>
    </tr>





  


      {% elif pkg_dict.type == 'wave' %}

      <tr>
        <th scope="row" class="dataset-label">Cohort</th>
        <td class="dataset-details">
        <ul class="dataset-resources list-unstyled">
        <li><a href="/cohort/{{pkg_dict.wave_cohort_ckan_id}}" class="label label-info">{{pkg_dict.wave_cohort}}</a></li>
        </ul>
        </td>
      </tr>

      <tr>
        <th scope="row" class="dataset-label">Subject age</th>
        <td class="dataset-details">
        <ul class="dataset-resources list-unstyled"> <li>
        {% if pkg_dict.wave_universe.find("-") == -1 %}
          {% set value = pkg_dict.wave_universe|int %}
          {% if value >= 48 %}
            {{ value/12|round }} years
          {% else %}
            {{ value }} months
          {% endif %}
        {% else %}
          {% set parts = pkg_dict.wave_universe.split("-") %}
          {% set start = parts[0]|int %}
          {% set end = parts[1]|int %}
          {% if start >= 48 %}
            {{ start/12|round }} -
          {% else %}
             {{ start }} months -
          {% endif %}
          {% if end >= 48 %}
           {{ end/12|round }} years
          {% else %}
           {{ end }} months
          {% endif %}
        {% endif %}
        </li>
        </ul>
        </td>
      </tr>
      {% if pkg_dict.wave_start_date_collection %}
      <tr>
        <th scope="row" class="dataset-label">Time span</th>
        <td class="dataset-details">
            From {{pkg_dict.wave_start_date_collection}} 
            {% if pkg_dict.wave_end_date_collection %} 
            to {{pkg_dict.wave_end_date_collection}} 
            {% else %}
            (ongoing)
            {% endif %}
        </td>
      </tr>
      {% endif %}
      <tr>
        <th scope="row" class="dataset-label">Geographic location</th>
        <td class="dataset-details">
        <span class="label" style="line-height:2">{{ pkg_dict.wave_spatial_geographic_location }} {{ pkg_dict.wave_spatial_country_code }}</span>
        </td>
      </tr>
      {% endif %}
      {% block package_additional_info_measure %}
      {% endblock %}
      
    </tbody>
  </table>

  <h4>Cohort Study</h4>
  <table class="table table-striped table-condensed dropshadow">
    {% block package_additional_info_measure %}
      {% endblock %}
  </table>



  <div class="search-result-api-message message" style="margin-top:100px">
    <span class="fa fa-lightbulb-o"></span>
          <small>
          You can also access this dataset using the <a href="/api/3/action/package_show?id={{pkg_dict.name}}">API</a> (see <a href="http://docs.ckan.org/en/2.9/api/">API Docs</a>).
          </small>
  </div>
  <div class="debug" style="display:none">
    <table class="table table-striped table-condensed">
      {% for key, value in pkg_dict.items() %}
        <tr><td>{{key}}</td><td>{{value}}</td></tr>
      {% endfor %}
     </table>
  </div>
</section>



